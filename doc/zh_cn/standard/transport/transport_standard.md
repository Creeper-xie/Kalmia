# 随机AES与IV （#R1）

山月桂必须完成随机AES密钥及初始化向量（IV）的交换才可以进行其他的数据交换

其中AES长度为32字节\
IV为16字节

每次新连接不可重复使用

# 非对称加密与密钥交换（#R2）

对非对称加密采用预共享公钥配合DH交换方式以规避中间人攻击

为了避免暴力破解\
RSA公钥最短长度需为8192\
ECC（椭圆曲线加密）公钥最短长度需为384

# 随机数据与时间戳 （#R3）

每个数据包需带有发送时的时间戳和一段随机数据

服务端在指定时间内记录此数据包的时间戳和数据\
拒绝处理同样随机数据或时间戳超时的数据包\
以此来防止重放攻击

# 数据包摘要 （#R4）

每个数据包需带有数据包有效数据的摘要信息，以此验证数据包完整性

# 数据包结构

## 当不启用Base36编码

山月桂的数据包通常由以下组成部分：

| 长度  |      1字节      |   4字节   |  X字节  |     
|:---:|:-------------:|:-------:|:-----:|
| 内容  |     字节'a'     |  编码数字   | 数据包内容 |     
| 意义  | 标记是否以Base36编码 | 标记数据包长度 | 数据包内容 |
| 标记  |      #1       |   #2    |  #3   | 

### 编码数字

参考：[数字编码标准](/doc/zh_cn/standard/transport/number/number_encode_standard.md)

## 当启用Base36编码

```
此部分暂未完善，请暂时不用参考
```

| 长度  |      1字节      |    1字节     |   X字节    |  X字节  |
|:---:|:-------------:|:----------:|:--------:|:-----:|
| 内容  |     字节'b'     |     数字     | Base36数字 | 数据包内容 |
| 意义  | 标记是否以Base36编码 | 标记数据包标记的长度 | 标记数据包长度  | 数据包内容 |
| 标记  |      #1       |     #2     |    #3    |  #4   |

# 数据包内容结构

## 负载

山月桂的数据包负载内容通常由以下组成部分：

| 长度  |  16字节  | 2~8字节  | 2~8字节  |  1或17字节  |  X字节  |  
|:---:|:------:|:------:|:------:|:--------:|:-----:|
| 内容  |  随机字节  | 编码跳过数字 | 编码跳过数字 |   随机字节   | 序列化数据 |
| 意义  |  随机字节  |  时间戳   | 数据包ID  |   回执标记   | 数据包详情 |
| 目的  | 防止重放攻击 | 防止重放攻击 | 数据包内容  | 用于回复特定消息 | 数据包详情 |
| 标记  |   #1   |   #2   |   #3   |    #4    |  #5   |

## 完整内容

| 长度  |  1字节   |   X字节   | X字节  |     
|:---:|:------:|:-------:|:----:|
| 内容  |   数字   | 256进制摘要 | 负载内容 |     
| 意义  | 标记摘要长度 |  数据包摘要  | 负载内容 |
| 标记  |   #1   |   #2    |  #3  | 
